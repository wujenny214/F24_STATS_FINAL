---
title: "Understanding the Impact of Socioeconomic and Regional Factors on Health and Educational Outcomes"
author: "Rishika Randev, Jenny Wu, Uzoma Uwazurike Jr., Shiyue Zhou"
instructor: "Andrea Lane"
institution: "Duke University, IDS 702 Data Modeling and Presentation"
format: html
editor: visual
execute:
  echo: false
  warning: false
---

## **Abstract**

## **Introduction**

### Background

Life expectancy and school funding are important indicators of public well-being because they capture fundamental aspects of health, education, and social equity that are essential for the development of individuals and communities. Life expectancy is an important health indicator that reflects not only the overall health of a society, but also its stability, economic resilience, and levels of inequality. For example, differences in life expectancy between regions and socioeconomic groups often reveal systemic inequalities, with marginalized communities experiencing shorter life spans due to limited access to health care, healthy living environments, and economic opportunities. Similarly, adequately funded schools mean that students have equal access to learning opportunities and are an important investment in social mobility. Underfunded schools are often located in economically disadvantaged or segregated areas, exacerbating educational gaps and limiting students’ potential to break the cycle of poverty. These gaps are rooted in systemic inequalities, such as residential segregation, which concentrates poverty, limits access to quality education and health care, and perpetuates income and health disparities across generations. By addressing these inequalities, policymakers can foster fairer, more prosperous communities and ensure that everyone benefits from improved health and education systems. 

### Research Questions

For this purpose, we focus on two key research questions to explore these relationships.  First, we investigate how socioeconomic factors—residential segregation, access to healthy foods, and health insurance coverage—impact average life expectancy. This analysis includes a comparison across different regions to identify variations in the relationship between residential segregation and life expectancy. Second, we evaluate how residential segregation, property taxes, and median household income influence school funding adequacy. This question allows us to assess educational investment disparities among regions with varying economic conditions. The observational unit for this analysis was the U.S. county.

### Data Overview

The dataset used in this study integrates information from three primary sources. 

The first source was the County Health Rankings & Roadmaps program, associated with the University of Wisconsin Population Health Institute, which provided us with 2024 datasets for all U.S. states. This program consolidates the latest county-level measurements of various population health, economic, demographic, and social factors from the American Community Survey, the USDA Food Environment Atlas, Small Area Income and Poverty Estimates, and other reliable government sources into publicly available datasets every year. Our specific variables of interest were originally collected as part of:

-   National Center for Health Statistics - Natality & Mortality Files, 2019-2021 (average life expectancy)

-   American Community Survey 5-year estimates, 2018-2022 (residential segregation index & median household income)

-   USDA Food Environment Atlas, 2019 (percentage of population with limited access to healthy foods)

-   Small Area Health Insurance Estimates, 2021 (percentage of adults uninsured)

-   School Finance Indicators Database, 2021 (school funding adequacy)

The second source was IPUMS, which provided us with median poverty tax data for every county from 2018-2022.

The third source was the U.S. Census Bureau’s Regions and Divisions of the United States, which maps every U.S. to one of our geographic regions, and also a division within the regions. We specifically included regions as a variable in this analysis. This data was loaded into R using a publicly available GitHub repository maintained by Halpert (2014), titled Census Regions. This repository provides the necessary mappings in CSV format, allowing for efficient integration of regional classification data.

## **Methods**

### Variable Selection

### Exploratory Data Analysis & Data Preprocessing

2024 datasets for all U.S. states were combined and merged with median property tax and region mapping data, resulting in a final dataset with 3144 county observations and 9 different variables (state, average life expectancy, residential segregation index, % limited access to healthy foods, % uninsured adults, school funding adequacy, median household income, median property tax, and region). Because school funding adequacy was given as a numerical value, and we wanted to focus simply on better understanding the dichotomy between school funding adequacy and inadequacy, it was converted into a binary categorical variable (1 if the numerical value was positive, indicating the counties’ schools were adequately funded, and 0 if the numerical value was negative, indicating underfunding).

Exploratory data analysis for the two outcome variables was conducted by creating  . During exploratory data analysis, we found that ⅓ of our observations were missing residential segregation index data, and in addition, certain states were missing nearly all of their segregation values. Because of this, we decided to drop all states missing over 50% of their values for any variable. Going forward, our analysis is limited to 33 states, and excludes the following: Alaska, Colorado, Idaho, Iowa, Kansas, Minnesota, Montana, Nebraska, North Dakota, South Dakota, Utah, Wyoming, and Vermont. We were left with 2379 total observations, and the missing percentage for residential segregation dropped to 22%.

After this, remaining missing values in all variables were imputed using the mice package and predictive mean matching to generate one complete dataset. The original school funding adequacy numerical variable was first imputed, and then converted into binary values for subsequent analysis.

### Model Fitting & Assessment

For our first research question, a multiple linear regression model was fit, regressing average life expectancy on residential segregation index, % limited access to healthy foods, % uninsured adults, and region. Linear regression assumptions were assessed using diagnostic plots, especially residual vs. fitted and quantile-quantile plots. The adjusted R-squared value was used to evaluate the fit of the model, and the effect of region as an interaction with residential segregation was evaluated using nested F tests. We also calculated VIF to understand multicollinearity and Cook’s distance to identify influential points. 

For our second research question, a binary logistic regression model was fit with school funding adequacy (categorical) as the outcome and residential segregation index, median property tax, and median household income as predictors. The model was assessed using a confusion matrix. ROC curve, and deviance.

## Results

### Data Overview

### Question 1

### Question 2

```{r, echo= FALSE, warning = FALSE, message=FALSE}
library("dplyr")
library(mice)
library(sjlabelled)
library(tidyverse)
library("modelsummary")
library(car)
```

```{r,echo= FALSE, warning = FALSE, message=FALSE}
combined <- read.csv('https://github.com/wujenny214/F24_STATS_FINAL/raw/refs/heads/main/combined.csv')
```

```{r, echo= FALSE, warning = FALSE}
# Making the state_fac variable a factor variable for future use
combined <- combined |> mutate(State_fac = factor(combined$State), Region_fac = factor(combined$Region, levels=c('South', 'West', 'Northeast', 'Midwest')))
```

```{r, echo= FALSE, warning = FALSE}
## Imputation Code 
# In this block, we are looking to use predictive mean matching to combing regression methods and hot deck imputing to predicted value closest to the predicted value of the observation with missing data; we also needed to convert school funding adequacy imputed values to school funding categorical variable before using in models

sub <- combined |> select(c("Life.Expectancy","Residential.Segregation.Index","X..Limited.Access.to.Healthy.Foods","X..Uninsured.Adults","Median.Household.Income", "School.Funding.Adequacy", "Median.Prop.Tax", "Region_fac"))
sub <- unlabel(sub) #unlabel the data (labels cause problem for the mice function)

# Add School.Funding.Cat to the orginal dataset. Since we do not want to imputate on the categorical outcome variable,  this creation of a variable exists to create the proper dataframe within the imputated data 
sub$School.Funding.Cat <- ifelse(sub$School.Funding.Adequacy > 0, 1, 0)  

# Perform the imputation
sub.imp <- mice(sub, m = 1, method = "pmm", print = FALSE)

```

```{r, echo= FALSE, warning = FALSE}
# Since we should not imputate on the outcome, but need to imputate the School.Funding.Adequacy variable, we are feeding the School.Funding.Adequacy variable into a ifelse conditional that will replaced the imputed outcome variable. 

# Define the categorization function
categorize_school_funding <- function(x) {
  ifelse(x > 0, 1, 0)  # Binary classification
}

# Loop over the imputations
for (i in 1:1) {
  # Extract the imputed values for the i-th dataset
  imputed_values <- sub.imp$imp$School.Funding.Adequacy[, i]
  
  # Categorize the imputed values
  categorized_values <- categorize_school_funding(imputed_values)
  complete_cat <- rep(NA, nrow(sub))  # Initialize with NAs
  
  # Get the indices where imputation occurred
  imp_indices <- which(!is.na(categorized_values))  # Only for imputed values

  # Assign the categorized values to the rows that were imputed
  complete_cat[imp_indices] <- categorized_values[imp_indices]
  
  # Save into the `imp` list of the `sub.imp` object
  sub.imp$imp$School.Funding.Cat[[i]] <- complete_cat[imp_indices]
}
```

```{r, echo= FALSE, warning = FALSE, include = FALSE }
# To have a full dataset, we are taking the first imputed dataset R provided and using that as our full dataset sample. 
completed_data <- complete(sub.imp, 1) 

# Check the structure
str(completed_data)

# Ensure that there are no missing data 
colSums(is.na(completed_data))

```

## Q1 Life Expectancy; MLR

### **Research Question 1: Life Expectancy**

### Model Fitting (Original Data)

```{r, echo= FALSE, warning = FALSE}
# MLR
# Outcome = life expectancy 
# Predictors = residential segregation, limited access to healthy foods, uninsured adults, region_fac as interaction with residential segregation (or any other variable)

# To get a general sense of what the data tells us, we use the orignial dataset with missing values. 

mlrmodel <- lm(
  Life.Expectancy ~ Residential.Segregation.Index +
  X..Limited.Access.to.Healthy.Foods +
  X..Uninsured.Adults +
  Region_fac,
  data = combined)

# Renaming the output names 
renamed <- c(
  "Residential.Segregation.Index" = "Residential Segregation Index (RSI)",
  "X..Limited.Access.to.Healthy.Foods" = "Access to Healthy Foods",
  "X..Uninsured.Adults" = "Pct. of Uninsured Adults",
  "Region_facWest" = "Region.W", 
  "Region_facNortheast" = "Region.NE",
  "Region_facMidwest" = "Region.MidW")

modelsummary(mlrmodel, fmt = fmt_significant(2),
             coef_rename = renamed, 
             shape = term ~ model + statistic,
             statistic = c("std.error","conf.int","p.value"),
             exponentiate = FALSE,
             gof_map=NA,
             )

```

### Model Fitting (Imputed Data)

```{r, echo= FALSE, warning = FALSE}
# Running a regression with the imputated data to understand the impact of missing data 

mlr.imp.mod <- with(sub.imp, lm(Life.Expectancy ~ Residential.Segregation.Index +
    X..Limited.Access.to.Healthy.Foods +
    X..Uninsured.Adults + 
    Region_fac))

renamed <- c(
  "Residential.Segregation.Index" = "Residential Segregation Index (RSI)",
  "X..Limited.Access.to.Healthy.Foods" = "Access to Healthy Foods",
  "X..Uninsured.Adults" = "Pct. of Uninsured Adults",
  "Region_facWest" = "Region.W", 
  "Region_facNortheast" = "Region.NE",
  "Region_facMidwest" = "Region.MidW"
  )

modelsummary(pool(mlr.imp.mod), fmt = fmt_significant(2),
             coef_rename = renamed, 
             shape = term ~ model + statistic,
             statistic = c("std.error","conf.int","p.value"),
             exponentiate = FALSE,
             gof_map=NA,
             )
```

```{r echo= FALSE, warning = FALSE}
# Running a regression with the interaction term between residential segregation on the regions 

mlr.imp.mod2 <- with(sub.imp, lm(Life.Expectancy ~ Residential.Segregation.Index +
    X..Limited.Access.to.Healthy.Foods +
    X..Uninsured.Adults + 
    Region_fac + 
    Region_fac * Residential.Segregation.Index))

renamed <- c(
  "Residential.Segregation.Index" = "Residential Segregation Index (RSI)",
  "X..Limited.Access.to.Healthy.Foods" = "Access to Healthy Foods",
  "X..Uninsured.Adults" = "Pct. of Uninsured Adults",
  "Region_facWest" = "Region.W", 
  "Region_facNortheast" = "Region.NE",
  "Region_facMidwest" = "Region.MidW", 
  "Residential.Segregation.Index:Region_facWest" = "RSI * Region.W ", 
  "Residential.Segregation.Index:Region_facNortheast" = "RSI * Region.NE",
  "Residential.Segregation.Index:Region_facMidwest" = "RSI * Region.MidW"
  )

modelsummary(pool(mlr.imp.mod2), fmt = fmt_significant(2),
             coef_rename = renamed, 
             shape = term ~ model + statistic,
             statistic = c("std.error","conf.int","p.value"),
             exponentiate = FALSE,
             gof_map=NA,
             )

```

### Evaluation & Assessment of Model

```{r}
#QQPlot
qqnorm(residuals(mlrmodel))
qqline(residuals(mlrmodel), col = "red") 
```

```{r}
##Nested F-Test
#Assuming we will drop %Uninsured Adults Predictor

reduced_model <- lm(Life.Expectancy ~ Residential.Segregation.Index + X..Limited.Access.to.Healthy.Foods, data = combined) 
  
# Nested F-Test
anova(reduced_model, mlrmodel)


```

```{r}
#Cooks Distance 
cooksd <- cooks.distance(mlrmodel)

# Plot Cook's Distance
plot(cooksd, main = "Cook's Distance", ylab = "Cook's Distance")
abline(h = 4/(nrow(data) - length(coef(mlrmodel))), col = "red")  # Threshold line

```

```{r include = FALSE}
# Identify Influential Points
influential <- which(cooksd > 4/(nrow(combined) - length(coef(mlrmodel))))
print(influential)
```

```{r}
#Variance Inflaction Factor (VIF)

vif(mlrmodel)
```

Results are all slightly greater than one meaning some correlation between factors but not much. Percentage of uninsured adults having the greatest correlation

```{r}
#Generate 4 Diagnostic Plots at once
par(mfrow = c(2, 2), mar = c(4,4,2,2))
plot(mlrmodel)
```

## Q2 **School Funding Adequacy; GLM**

### **Research Question 2: School Funding Adequacy**

### Model Fitting

```{r}
## Checking to see if the imputated data has a large effect on the outcome 

# Logistic Regression without Imputated Data
# Outcome = School.Funding.Cat
# Predictors = residential segregation, median.household.income, median.prop.tax

lmod <- glm(School.Funding.Cat ~ Residential.Segregation.Index + Median.Household.Income + Median.Prop.Tax,
              data=combined,
              family="binomial")

library("modelsummary")

#log-odds scale
modelsummary(lmod,
             fmt = fmt_significant(2),
             shape = term ~ model + statistic,
             statistic = c("std.error","conf.int","p.value"),
             exponentiate = FALSE,
             gof_map=NA)

modelsummary(lmod,
             fmt = fmt_significant(2),
             shape = term ~ model + statistic,
             statistic = c("std.error","conf.int","p.value"),
             exponentiate = TRUE,
             gof_map=NA)

```

### Regression Results

```{r}
imp_mods <- with(sub.imp, glm(School.Funding.Cat ~ Residential.Segregation.Index + Median.Household.Income + Median.Prop.Tax), family="binomial")

#log-odds scale
modelsummary(pool(imp_mods),
             fmt = fmt_significant(2),
             shape = term ~ model + statistic,
             statistic = c("std.error","conf.int","p.value"),
             exponentiate = FALSE,
             gof_map=NA)

modelsummary(pool(imp_mods),
             fmt = fmt_significant(2),
             shape = term ~ model + statistic,
             statistic = c("std.error","conf.int","p.value"),
             exponentiate = TRUE,
             gof_map=NA)
```

### Evaluation and Assessment of Model

```{r}
# Creating the confusion matrix 

library(caret)
library(pROC)

# set.seed(42)
# train_idx <- sample(1:nrow(long_data), size = 0.5 * nrow(long_data))
# train_data <- long_data[train_idx, ]
# test_data <- long_data[-train_idx, ]

t_glm_model <- glm(School.Funding.Cat ~ Residential.Segregation.Index + Median.Household.Income + Median.Prop.Tax, data = completed_data, family = binomial)

# Make predictions on the test set
test_probs <- predict(t_glm_model, newdata = completed_data, type = "response")
test_pred <- ifelse(test_probs > 0.5, 1, 0)  # Classify based on threshold 0.5
```

```{r}
# Create a confusion matrix
library("caret")
conf_matrix <- confusionMatrix(factor(test_pred), factor(completed_data$School.Funding.Cat))
#print(conf_matrix)

library(pander)

# Format and display confusion matrix as a Markdown table
pander(conf_matrix, caption = "Confusion Matrix")

```

```{r}
#Creating the AUC curves
roc_result <- roc(
  completed_data$School.Funding.Cat,
  predict(t_glm_model, type = "response"),
  legacy.axes = TRUE,
  plot = TRUE,
  print.thres = 0.5,
  print.auc = FALSE  # Disable automatic AUC
)

# Add AUC manually
text(
  x = 1.2,  # Adjust X-coordinate
  y = 1,  # Adjust Y-coordinate
  labels = sprintf("AUC = %.3f", auc(roc_result)),  # Add AUC value
  cex = 1,  # Label size
  col = "red"  # Label color
)
```

```{r}

```
