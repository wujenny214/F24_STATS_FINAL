---
title: "analysis"
format: html
editor: visual
---

## Load Data & Create Factors

```{r, echo= FALSE}
library("dplyr")
library(mice)
library(sjlabelled)
library(tidyverse)


combined <- read.csv('https://github.com/wujenny214/F24_STATS_FINAL/raw/refs/heads/main/combined.csv')
```

```{r}
head(combined)
```

```{r}
combined <- combined |> mutate(State_fac = factor(combined$State), Region_fac = factor(combined$Region, levels=c('South', 'West', 'Northeast', 'Midwest')))
```

```{r}
combined <- combined %>% select(-X, -Spending.per.Pupil)
```

```{r}
head(combined)
```

## Imputation

```{r}
sub <- combined |> select(c("Life.Expectancy","Residential.Segregation.Index","X..Limited.Access.to.Healthy.Foods","X..Uninsured.Adults","Median.Household.Income", "School.Funding.Adequacy", "Median.Prop.Tax", "Region_fac"))
sub <- unlabel(sub) #unlabel the data (labels cause problem for the mice function)
sub.imp <- mice(sub, m=5, method="pmm", print=FALSE)
```

```{r}
#Need to convert school funding adequacy imputed values to school funding categorical variable before using in models
# imputated data has 5 dataframes within a list, need to run a loop for all five datasets to create a categorical variable for each set. 
```

## Q1

```{r}
#MLR
# Outcome = life expectancy #Predictors = residential segregation, limited access to healthy foods, uninsured adults, region_fac as interaction with residential segregation (or any other variable)

mlrmodel <- lm(
  Life.Expectancy ~ Residential.Segregation.Index +
    X..Limited.Access.to.Healthy.Foods +
    X..Uninsured.Adults,
  data = combined)
summary(mlrmodel)

```

```{r}
mlr.imp.mod <- with(sub.imp, lm(Life.Expectancy ~ Residential.Segregation.Index +
    X..Limited.Access.to.Healthy.Foods +
    X..Uninsured.Adults + 
    Region_fac))

summary(pool(mlr.imp.mod))
```

```{r}
mlr.imp.mod2 <- with(sub.imp, lm(Life.Expectancy ~ Residential.Segregation.Index +
    X..Limited.Access.to.Healthy.Foods +
    X..Uninsured.Adults + 
    Region_fac + 
    Region_fac * Residential.Segregation.Index))

summary(pool(mlr.imp.mod2))
```

\@ UZO: Add plots to check assumptions: QQ plot, nested F-test, write p-value interpretations, VIF, Cooks distance

```{r}
#QQPlot
qqnorm(residuals(mlrmodel))
qqline(residuals(mlrmodel), col = "red") 
```

```{r}
##Nested F-Test
#Assuming we will drop %Uninsured Adults Predictor

#print(colnames(combined))
reduced_model <- lm(Life.Expectancy ~ Residential.Segregation.Index + X..Limited.Access.to.Healthy.Foods, data = combined) 
  
# Nested F-Test
anova(reduced_model, mlrmodel)
```

```{r}
#Cooks Distance 
cooksd <- cooks.distance(mlrmodel)

# Plot Cook's Distance
plot(cooksd, main = "Cook's Distance", ylab = "Cook's Distance")
abline(h = 4/(nrow(data) - length(coef(mlrmodel))), col = "red")  # Threshold line

# Identify Influential Points
influential <- which(cooksd > 4/(nrow(combined) - length(coef(mlrmodel))))
print(influential)
```

```{r}
#Variance Inflaction Factor (VIF)
library(car)
vif(mlrmodel)

```

Results are all slightly greater than one meaning some correlation between factors but not much. Percentage of uninsured adults having the greatest correlation

```{r}
#Generate 4 Diagnostic Plots at once
par(mfrow = c(2, 2), mar = c(4,4,2,2))
plot(mlrmodel)
```

## Q2

```{r}
#Logistic 
lmod <- glm(School.Funding.Cat ~ Residential.Segregation.Index + Median.Household.Income + Median.Prop.Tax,
              data=combined,
              family="binomial")
summary(lmod)

with(sub.imp, glm(School.Funding.Cat ~ Residential.Segregation.Index + Median.Household.Income + Median.Prop.Tax, family="binomial"))

#Outcome = School.Funding.Cat
#Predictors = residential segregation, median.household.income, median.prop.tax
```
